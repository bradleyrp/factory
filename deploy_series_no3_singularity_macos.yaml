### SINGULARITY via DOCKER on macos

#! custom for macos right now
vagrant_setup:
  site: ~/worker/vagrant-springboard
  singularity_version: 2.6

docker_singularity:
  persist: true
  site: "@deploy_site"
  rebuild: false 
  script: |
    echo "docker_singularity is built!"
  dockerfile:
    sequence:
      - stretch
      - debian_start
      - debian_compilers
      - debian_mysql
      - debian_shell_bash
      - singularity
    addendum:
      #! needs shell substitution
      - WORKDIR /home/rpb/extern
  command: docker-compose run --service-ports deploy
  compose:
    version: '3'
    services:
      deploy:
        privileged: true
        entrypoint: ['/bin/bash','script.sh']
        build: .
        image: factory:docker_singularity
        container_name: docker_singularity_deploy
        volumes: #! volumes required for script.sh
          - ./:/home/rpb/extern
      visit:
        privileged: true
        build: .
        image: factory:docker_singularity
        stdin_open: true
        tty: true
        command: ['/bin/bash']
        container_name: docker_singularity_visit
        volumes: #! volumes required for script.sh
          - ./:/home/rpb/extern

### recipes for making Singularity containers

makerspace_build:
  via: docker_singularity
  overrides:
    script: |
      set -e -x 
      echo "The makerspace_build recipe should be used by a custom recipe."
      exit 1

makerspace_enliven:
  via: makerspace_build
  overrides:
    #! systematize the container names
    script: |
      set -e -x
      # convert a containter to a writable one
      export SIZE=4096
      singularity image.create --size $SIZE live.simg
      singularity build --writable live.simg container.simg
      # visit at the end
      singularity shell --writable live.simg

makerspace_visit:
  via: makerspace_build
  overrides:
    command: docker-compose run --service-ports deploy

makerspace_visit_docker:
  via: makerspace_build
  overrides:
    command: docker-compose run --service-ports visit
