# BLUE CRAB SOFTWARE STACK 
# Build and organize software for this cluster.
# USAGE: make spack_hpc_run run=specs/spack_hpc_run.yaml deploy=specs/spack_bc_proot.yaml name=bc-prelim live

# SETTINGS: spack source and environments locations 
spot:       ./local/spack       # config.json, spack
spot_envs:  ./local/envs-spack  # config.json, spack_envs

###
### SOFTWARE SPECIFICATION
###

arch: &arch "arch=linux-centos7-haswell"
gcc-back-compiler: &gcc-back-compiler gcc@4.8.5
gcc-back: &gcc-back !strflush ["%", *gcc-back-compiler]
gcc-7-compiler: &gcc-7-compiler gcc@7.4.0
gcc-7: &gcc-7 !strflush ["%", *gcc-7-compiler, " ", *arch]
python3: &python-3 >-
  python@3.7.6 +bz2 +ctypes +dbm +debug 
  +libxml2 +lzma +optimizations +pic +pyexpat +pythoncmd 
  +readline +shared +sqlite3 +ssl +uuid +zlib
r36: &r36 !chain
  - r@3.6.1 +memory_profiling
  - *python-3

wl02: &wl02 !merge_lists
  #! define below because !merge_lists cannot use refs?
  - &r-packages [r-devtools, r-rcpp]
  - &wl01 [gcc, python, r]

###
### CONFIGURATION
###

# spack environments template (spack.yaml)
template_basic: 
  concretization: separately
  mirrors: {}
  repos: []
  upstreams: {}
  modules:
    enable: []
  definitions: []
  packages: {}
  config: 
    checksum: false
  specs: []
  view: false

# BUILD CONFIGURATION
# matched to the deploy file
bc-config: 
  config: &bc-config
    install_tree: /software/apps/spack/a02
    module_roots: 
      lmod: &module-spot /software/apps/spack/m02
    build_stage:
      - "$TMPDIR/$USER/spack-stage"
    misc_cache: /software/apps/spack/a02/cache_misc
  packages: &packages
    slurm:
      paths:
        slurm@17.11.12: /software/apps/slurm/17.11.12.1.marcc
      buildable: false
      version: []
      providers: {}
      modules: {}
      compiler: []
    openssl:
      paths: {openssl@1.0.2k: /usr}
      buildable: false

bc-config-modules:
  s01: &mod-stage-01
    enable: 
      - lmod
    lmod:
      all:
        conflict: []
        environment:
          unset: []
        filter:
          environment_blacklist: []
        load: []
      blacklist_implicits: false
      core_compilers:
      - *gcc-back-compiler
      hash_length: 0
      naming_scheme: '{name}/{version}/{compiler.name}/{compiler.version}'
      hierarchy:
      - compiler
      verbose: false

bc-config-modules:
  s01: &mod-stage-02
    enable: 
      - lmod
    lmod: &mod-stage-02-lmod
      all:
        conflict: []
        environment:
          unset: []
        filter:
          environment_blacklist: []
        load: []
      naming_scheme: '{name}/{version}/{compiler.name}/{compiler.version}'
      blacklist_implicits: true
      core_compilers:
      - *gcc-back-compiler
      blacklist: 
      - *gcc-back
      hash_length: 0
      hierarchy:
      - compiler
      verbose: false

mods_config:
  mods: &mc01
    config: *bc-config
    packages: *packages
    modules: *mod-stage-01

mods_config:
  mods: &mc02
    config: *bc-config
    packages: *packages
    modules: 
      enable: [lmod]
      lmod: 
        << : *mod-stage-02-lmod
        whitelist: *wl02

###
### ENVIRONMENTS
###

bc-prelim: 
  notes: Initial test before running a compiler build.
  envs:
    - find_compilers: null
    - check_compiler: *gcc-back-compiler
    - bootstrap: null
    - name: env-prelim
      via: template_basic
      mods: *mc01
      specs:
        - !str [zlib, *gcc-back, *arch]
        - !str [cmake, *gcc-back, *arch]

bc-gcc-7-compiler:
  notes: Compile gcc 7 for Blue Crab.
  envs:
    - find_compilers: null
    - check_compiler: *gcc-back-compiler
    - bootstrap: null
    - name: &env-gcc-7-compiler env-gcc-7-compiler
      via: template_basic
      mods: *mc01
      specs:
        - !str &gcc-7-out [*gcc-7-compiler, *gcc-back, *arch]
    - find: *gcc-7-compiler 
      name: *env-gcc-7-compiler

bc-stage02:
  notes: Blue Crab base apps built on gcc7.
  envs:
    - check_compiler: *gcc-7-compiler
    - name: &env-stage02 env-stage02
      via: template_basic
      mods: *mc02
      specs: !merge_lists
        - [*gcc-7-out]
        - [!str [*python-3, *gcc-7]]
        - [!str [*r36, *gcc-7]]
        - !loopcat
          base: !strflush [" ^", *r36, *gcc-7]
          loop: *r-packages
    - lmod_refresh: null
      name: *env-stage02
