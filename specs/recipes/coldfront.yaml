dockerfiles: !merge_spec
  external: !import_spec 
    from: ./dockerfiles.yaml
    what: dockerfiles
  local:
    coldfront: |
      RUN apt-get -y update
      RUN apt-get -y install python3 python3-venv memcached redis-server
select: !select
  coldfront_setup:
    via: coldfront
    mods: 
      visit: true
      command: docker-compose run -w /home/user/coldfront --service-ports deploy 
      compose: 
        services:
          deploy:
            entrypoint: "/bin/bash"
  coldfront:
    notes: 
      docs: |
        # TESTING COLDFRONT IN DOCKER
        # instructions via https://github.com/ubccr/coldfront
        # first we use the setup recipe. this builds a persistent coldfront
        # prepare a location outside of the container (not necessary on macos)
        mkdir local/coldfront
        make docker specs/recipes/coldfront.yaml coldfront_setup
        # the following setup commands could be rolled into the dockerfile
        cd ~/coldfront
        git clone https://github.com/ubccr/coldfront.git
        # venv next to the app
        python3 -mvenv venv
        source venv/bin/activate
        # onetime venv build
        cd coldfront
        python -m pip install wheel
        python -m pip install -r requirements.txt
        # onetime setup via docs
        cp coldfront/config/local_settings.py.sample \
        coldfront/config/local_settings.py
        cp coldfront/config/local_strings.py.sample \
        coldfront/config/local_strings.py
        python manage.py initial_setup
        exit
        # to run the server and continue development
        make docker specs/recipes/coldfront.yaml coldfront
      coldfront-up: &coldfront-up-entry
        - '/bin/bash'
        - '-c'
        - >-
          source ~/coldfront/venv/bin/activate &&
          cd ~/coldfront/coldfront && 
          python manage.py runserver 0.0.0.0:8000
    image_name: &image_name_coldfront factory:coldfront
    command: docker-compose up -d
    site: !spots root
    dockerfile:
      series:
        - bionic
        - ubuntu_build
        - coldfront
        - user_sudo_ubuntu
    compose:
      version: '3'
      services:
        deploy:
          entrypoint: *coldfront-up-entry
          build: .
          image: *image_name_coldfront
          volumes:
            - $FACTORY_ROOT/local/coldfront:/home/user/coldfront
          #!!! critical note: use "8000:8000" and not "8000" or no tunnel
          ports: ["8000:8000"]
          hostname: localhost
          container_name: coldfront
          working_dir: /home/user/coldfront
