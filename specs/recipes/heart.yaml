
### HEARTLAND RECIPES
### These recipes deploy codes for the Trayanova lab.
### By: Ryan Bradley
### Circa 2020 January

### DOCKER

dockerfiles: !merge_spec
  external: !import_spec 
    from: ./dockerfiles.yaml
    what: dockerfiles
  local:
    carp_meshalyzer_reqs: |
      # section: install carp and meshalyzer
      RUN apt-get -y update --fix-missing
      RUN apt-get install -y fltk1.3-dev
      RUN apt-get install -y libpng-dev
      RUN apt-get install -y libglew-dev 
      RUN apt-get install -y freeglut3-dev
    carp_meshalyzer: |
      RUN cd /tmp && \
          mkdir -p ./build-carp && \
          mkdir /usr/local/carp-1.1 && \
          cd ./build-carp && \
          wget https://carp.medunigraz.at/carpentry/cme.linux.tar.gz && \
          tar xvf cme.linux.tar.gz && \
          cd cme-1.1-linux && \
          echo "/usr/local/carp-1.1\ny\ny\ny\n" \
          | ./install_linux.sh
      RUN ln -s /usr/local/carp-1.1/meshalyzer/src/meshalyzer /usr/bin/meshalyzer
      RUN echo "source /usr/local/carp-1.1/config.sh" >> /etc/bash.bashrc
    carp_license: |
      USER root
      RUN chown user:users /usr/local/carp-1.1/license.bin
      USER user
    emacs26: |
      RUN apt-get install -y software-properties-common
      RUN add-apt-repository -y ppa:kelleyk/emacs
      RUN apt-get install -y emacs26
    jdk-13: |
      RUN apt-get install -y software-properties-common
      RUN add-apt-repository -y ppa:linuxuprising/java
      RUN echo debconf shared/accepted-oracle-license-v1-2 select true | debconf-set-selections
      RUN echo debconf shared/accepted-oracle-license-v1-2 seen true | debconf-set-selections
      RUN apt-get install -y openjdk-13-jdk
    jdk-11: |
      RUN apt-get install -y software-properties-common
      RUN add-apt-repository -y ppa:linuxuprising/java
      RUN echo debconf shared/accepted-oracle-license-v1-2 select true | debconf-set-selections
      RUN echo debconf shared/accepted-oracle-license-v1-2 seen true | debconf-set-selections
      RUN apt-get install -y openjdk-11-jdk
    clojure: | # https://github.com/Quantisan/docker-clojure/blob/be736864bf3e6d35c1bc6b13fd2add4a319fb92b/target/openjdk-13-buster/lein/Dockerfile
      ENV LEIN_VERSION=2.9.1
      ENV LEIN_INSTALL=/usr/local/bin/
      WORKDIR /tmp
      RUN \
      mkdir -p $LEIN_INSTALL && \
      wget -q https://raw.githubusercontent.com/technomancy/leiningen/$LEIN_VERSION/bin/lein-pkg && \
      echo "Comparing lein-pkg checksum ..." && \
      sha1sum lein-pkg && \
      echo "93be2c23ab4ff2fc4fcf531d7510ca4069b8d24a *lein-pkg" | sha1sum -c - && \
      mv lein-pkg $LEIN_INSTALL/lein && \
      chmod 0755 $LEIN_INSTALL/lein && \
      wget -q https://github.com/technomancy/leiningen/releases/download/$LEIN_VERSION/leiningen-$LEIN_VERSION-standalone.zip && \
      wget -q https://github.com/technomancy/leiningen/releases/download/$LEIN_VERSION/leiningen-$LEIN_VERSION-standalone.zip.asc && \
      rm leiningen-$LEIN_VERSION-standalone.zip.asc && \
      mkdir -p /usr/share/java && \
      mv leiningen-$LEIN_VERSION-standalone.zip /usr/share/java/leiningen-$LEIN_VERSION-standalone.jar
      ENV PATH=$PATH:$LEIN_INSTALL
      ENV LEIN_ROOT 1
      # Install clojure 1.10.1 so users don't have to download it every time
      RUN echo '(defproject dummy "" :dependencies [[org.clojure/clojure "1.10.1"]])' > project.clj \
        && lein deps && rm project.clj
    godot: |
      RUN apt-get install -y unzip
      RUN apt-get install -y mesa-utils libgl1-mesa-glx
      WORKDIR /tmp
      RUN wget https://downloads.tuxfamily.org/godotengine/3.1.2/Godot_v3.1.2-stable_x11.64.zip
    ubuntu_mkl: |
      RUN apt-get install -y cpio
      RUN cd /tmp && \
        wget -q http://registrationcenter-download.intel.com/akdlm/irc_nas/tec/15275/l_mkl_2019.3.199.tgz && \
        tar -xzf l_mkl_2019.3.199.tgz && \
        cd l_mkl_2019.3.199 && \
        sed -i 's/ACCEPT_EULA=decline/ACCEPT_EULA=accept/g' silent.cfg && \
        sed -i 's/ARCH_SELECTED=ALL/ARCH_SELECTED=INTEL64/g' silent.cfg && \
        sed -i 's/COMPONENTS=DEFAULTS/COMPONENTS=;intel-comp-l-all-vars__noarch;intel-comp-nomcu-vars__noarch;intel-openmp__x86_64;intel-tbb-libs__x86_64;intel-mkl-common__noarch;intel-mkl-installer-license__noarch;intel-mkl-core__x86_64;intel-mkl-core-rt__x86_64;intel-mkl-doc__noarch;intel-mkl-doc-ps__noarch;intel-mkl-gnu__x86_64;intel-mkl-gnu-rt__x86_64;intel-mkl-common-ps__noarch;intel-mkl-core-ps__x86_64;intel-mkl-common-c__noarch;intel-mkl-core-c__x86_64;intel-mkl-common-c-ps__noarch;intel-mkl-tbb__x86_64;intel-mkl-tbb-rt__x86_64;intel-mkl-gnu-c__x86_64;intel-mkl-common-f__noarch;intel-mkl-core-f__x86_64;intel-mkl-gnu-f-rt__x86_64;intel-mkl-gnu-f__x86_64;intel-mkl-f95-common__noarch;intel-mkl-f__x86_64;intel-mkl-psxe__noarch;intel-psxe-common__noarch;intel-psxe-common-doc__noarch;intel-compxe-pset/g' silent.cfg && \
        ./install.sh -s silent.cfg && \
        cd .. && rm -rf * && \
        rm -rf /opt/intel/.*.log /opt/intel/compilers_and_libraries_2019.3.199/licensing && \
        echo "/opt/intel/mkl/lib/intel64" >> /etc/ld.so.conf.d/intel.conf && \
        ldconfig && \
        echo "source /opt/intel/mkl/bin/mklvars.sh intel64" >> /etc/bash.bashrc
    vertigo_lein_user: |
      WORKDIR /tmp
      RUN mkdir vertigo_lein_user && cd vertigo_lein_user && echo '(defproject vertigo "0.1.0-SNAPSHOT" :plugins [[lein-git-deps "0.0.1-SNAPSHOT"] [lein-with-env-vars "0.2.0"] [cider/cider-nrepl "0.23.0"]] :git-dependencies [["https://github.com/bmillare/dj3.git"]] :dependencies [[org.clojure/clojure "1.10.0"] [org.bmillare/dj.core "0.2.0"] [com.cemerick/pomegranate "1.1.0"] [org.bmillare/dj.treefn "0.2.0"] [uncomplicate/neanderthal "0.26.1"] [nrepl "0.6.0"] [clojure-complete "0.2.5"]])' > project.clj && cat project.clj && lein install
      WORKDIR /home/user

dockerfile_carp_meshalyzer: &dockerfile_carp_meshalyzer
  series:
    - bionic
    - ubuntu_build
    - carp_meshalyzer_reqs
    - carp_meshalyzer
    - emacs26
    - jdk-13
    - clojure
    - godot
    - ubuntu_mkl
    - user_sudo_ubuntu
    - carp_license
    - vertigo_lein_user

dockerfile_heart_min: &dockerfile_heart_min
  series:
    - bionic
    - ubuntu_build
    - jdk-13
    - clojure
    - user_sudo_ubuntu

dockerfile_heart_min_8: &dockerfile_heart_min_8
  series:
    - bionic
    - ubuntu_build
    - jdk-11
    - user_sudo_ubuntu

### SETTINGS

# method for running GUI apps on macos
macos_docker_display: &macos_docker_display >-
  DISPLAY=docker.for.mac.host.internal:0
# factory root location on spacegray macbook
factory-root: &factory-root /Users/rpb/worker/heart/factory
workdir: &workdir /Users/rpb/worker
hearts_code: &directed-graph-code
  !!python/object/apply:os.path.join [*workdir,
  "hearts-code/directed-graph-rotor-analysis"]

# RECIPE SELECTION
# select recipe: `make docker specs/recipes/heart.yaml name=<name>`
select: !select

  carp:
    #! prevent this from running directly
    #! confirm linux
    image_name: &image_name_ubuntu heartland:carp_meshalyzer
    command: docker-compose up deploy
    dockerfile: *dockerfile_carp_meshalyzer
    #! using volumes instead of: site: local, spot, darwin_ok
    compose:
      version: '3.7'
      services:
        deploy:
          container_name: carp
          entrypoint: ['/bin/bash','-l']
          build: .
          image: *image_name_ubuntu
          ports:
            - 9011:9011
            - 9012:9012
          environment:
            - DISPLAY=$DISPLAY
          devices:
            - /dev/dri 
            - /dev/snd
            - /dev/nvidia0

  carp_macos:
    #! make an automatic switch for detecting macos?
    #! prevent this from running directly because wrong mounts
    via: carp
    mods:
      # this uses a gui on macos machines via socat
      macos_gui: True
      compose:
        services:
          deploy:
            environment:
              - *macos_docker_display

  dg_ex02:
    #!!! needs tested
    via: carp
    mods:
      compose:
        services:
          deploy:
            volumes: 
            - source: /home/rpb/work/hearts-code/directed-graph-rotor-analysis
              target: /home/user/code
              type: bind
            - source: /home/rpb/work/hearts-data/2019.12.11-directed-graph-input-example-e01
              target: /home/user/source
              type: bind
  
  vertigo_v02:
    # ok to use
    # macbook deployment
    via: carp_macos
    mods:
      #! this is still visiting! no link to compose folder because visit
      command: docker-compose up -d deploy
      compose:
        services:
          deploy:
            devices: []
            volumes: 
            # using the redeploy site which is currently deprecated
            - source: /Users/rpb/worker/heart/2020.01.22-vertigo-redeploy
              target: /home/user/spot
              type: bind
            ports:
            - 9011:9011
            - 9012:9012
            - 9020:9020
            entrypoint:
              '/bin/bash -c "cd /home/user/spot/vertigo && 
              source /usr/local/carp-1.1/config.sh && 
              lein repl :headless :host 0.0.0.0 :port 9020"'

  vertigo_v02_visit:
    # ok to use
    # macbook deployment, visit
    notes: |
      This is a canonical visit recipe, piggybacking off of another recipe.
    via: vertigo_v02
    mods:
      visit: true
      compose: {services: {deploy: {entrypoint: '/bin/bash -l'}}}
      command: docker-compose run --service-ports deploy

  vertigo_v03:
    # heartland deployment
    via: vertigo_v02
    mods: 
      compose:
        services:
          deploy:
            volumes: 
            - source: /home/rpb/work/hearts-data/2020.01.25-vertigo-v03
              target: /home/user/spot/data
              type: bind
            - source: /home/rpb/work/hearts-code/vertigo
              target: /home/user/spot/vertigo
              type: bind

  vertigo_v03_visit:
    # heartland visit
    via: carp
    mods: 
      visit: true
      compose: {services: {deploy: {entrypoint: '/bin/bash -l'}}}
      command: docker-compose run --service-ports deploy
      compose:
        services:
          deploy:
            container_name: carp_visit
            volumes: 
            - source: /home/rpb/work/hearts-data/2020.01.25-vertigo-v03
              target: /home/user/spot/data
              type: bind
            - source: /home/rpb/work/hearts-code/vertigo
              target: /home/user/spot/vertigo
              type: bind
            - /tmp/.X11-unix:/tmp/.X11-unix
            ports: []

  min:
    # a minimal testing environment
    image_name: &image_name_min heartland:basic
    command: docker-compose run --service-ports deploy
    dockerfile: *dockerfile_heart_min_8
    visit: True
    compose:
      version: '3.7'
      services:
        deploy:
          entrypoint: ['/bin/bash','-l']
          build: .
          image: *image_name_min
          volumes: 
          - source: *factory-root
            target: /home/user/extern
            type: bind

  vertigo_v04_visit:
    via: carp
    mods: 
      visit: true
      #! compose: {services: {deploy: {entrypoint: '/bin/bash -l'}}}
      command: docker-compose run --service-ports deploy
      compose:
        services:
          deploy:
            container_name: carp_visit
            volumes: 
            - source: /home/rpb/work/hearts-data/2020.02.03-test-4surf-atria-f-M15_400
              target: /home/user/spot/data
              type: bind
            - source: /home/rpb/work/hearts-code/vertigo
              target: /home/user/spot/vertigo
              type: bind
            - /tmp/.X11-unix:/tmp/.X11-unix
            ports: []

  vertigo_v04:
    notes: |
      Tested on 2020.02.05 on heartland (a desktop) via:
        `make docker specs/recipes/heart.yaml name=vertigo_v04`
      Code via: factory@bbfeef, vertigo@f1cf53.
      This runs in the foreground.
    via: carp
    mods: 
      command: docker-compose run --service-ports deploy
      compose:
        services:
          deploy:
            container_name: carp_visit
            volumes: 
            - source: /home/rpb/work/hearts-data/2020.02.03-test-4surf-atria-f-M15_400
              target: /home/user/spot/data
              type: bind
            - source: /home/rpb/work/hearts-code/vertigo
              target: /home/user/spot/vertigo
              type: bind
            - /tmp/.X11-unix:/tmp/.X11-unix
            entrypoint: >-
              /bin/bash -lic 'cd ~/spot/vertigo &&
              time lein run -- -n block01 runargs docker-v01 expt-v02'
