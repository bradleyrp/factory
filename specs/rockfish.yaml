# USAGE: `make do specs/rockfish.yaml name=test` except where otherwise
select: !select 

  # variables
  vars:
    spec: &spec specs/spack_rockfish.yaml
    mirror: &mirror 
      name: testbed
      spot: local/spack/mirror-spot
    prefix: &prefix ~/local/stack
    #! redundant with items in spack_rockfish.yaml but useful in setup below
    template_basic: &template_basic
      concretization: separately
      mirrors: {}
      repos: []
      upstreams: {}
      modules:
        enable: []
      definitions: []
      packages: {}
      config: 
        checksum: false
        # avoid the default cache in the home directory
        misc_cache: $spack/misc_cache
      specs: []
      view: false

  # RECIPE: preliminary setup
  # usage: make spack specs/rockfish.yaml setup
  setup:
    # talk directly to lib.spack in the same format as spack_tree.yaml
    # the first step compilest he code
    - !!python/object/apply:lib.spack.spack_seq_alt
      kwds:
        ref: *spec
        envs:
          - find_compilers: null
          - name: env_lmod
            via: template_basic
            specs: ['lmod']
    # repeat to the cache mirror
    - !!python/object/apply:lib.spack.spack_seq_alt
      kwds:
        ref: *spec
        envs:
          - find_compilers: null
          - name: env_lmod
            via: template_basic
            specs: ['lmod']
            cache_mirror: !!python/object/apply:lib.spack.SpackMirror 
              kwds: *mirror
    # this do item is redundant with the lmod spec above
    - !!python/object/apply:lib.spack.spack_install_cache
      kwds:
        spec: *spec
        target: *prefix
        do: lmod_base

  # RECIPE: build with cache
  # usage: make spack specs/rockfish.yaml cache do=<name>
  cache: 
    - !!python/object/apply:lib.spack.spack_env_install
      kwds:
        spec: *spec
        # cli argument to select the environment name in the spec
        do: !cli do
    - !!python/object/apply:lib.spack.spack_env_cache
      kwds:
        spec: *spec
        cache_mirror: !!python/object/apply:lib.spack.SpackMirror 
          kwds: *mirror
        # cli argument to select the environment name in the spec
        do: !cli do

  # recipe: deploy to an install location
  # usage: make spack specs/rockfish.yaml deploy do=<name>
  deploy:
    # deploy to the location
    - !!python/object/apply:lib.spack.spack_install_cache
      kwds:
        spec: *spec
        target: *prefix
        do: !cli do
    # refresh modules ...!!! spack -e . module lmod refresh