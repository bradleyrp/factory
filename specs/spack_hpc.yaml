note: |
  https://github.com/spack/spack/issues/7448
  https://stackoverflow.com/questions/37055420/python-how-can-i-tell-if-my-python-has-ssl
    python -c "import ssl; print(ssl.OPENSSL_VERSION)"
  https://spack.readthedocs.io/en/latest/mirrors.html
    adding a mirror really adds a line in ~/.spack/mirrors.yaml
      and this is not mapped in singularity so my activity outside was invisible
    actually no it does mount the home directory

        ==> openssl@1.0.2k : externally installed in /usr
        ==> openssl@1.0.2k : already registered in DB
        ==> sqlite is already installed in /software/apps/spack/a02/linux-centos7-haswell/gcc-7.4.0/sqlite-3.30.1-4mhcwk26zdrp3bkbxjsylduk7uzvfmz4
        ==> Installing python
        ==> Searching for binary cache of python
        ==> Finding buildcaches in /exec/rbradley/buildsite/factory/local/spack/var/spack/cache/build_cache
        ==> No binary for python found: installing from source
        ==> Warning: Expected user 3284 to own /exec/rbradley, but it is owned by 0
        curl: (37) Couldn't open file /exec/rbradley/buildsite/factory/local/spack/var/spack/cache/python/python-3.7.tgz
        curl: (22) The requested URL returned error: 404 Not Found
        ==> Fetching file:///exec/rbradley/buildsite/factory/local/spack/var/spack/cache/python/python-3.7.tgz
        ==> Failed to fetch file from URL: file:///exec/rbradley/buildsite/factory/local/spack/var/spack/cache/python/python-3.7.tgz
            Curl failed with error 37
        ==> Fetching from file:///exec/rbradley/buildsite/factory/local/spack/var/spack/cache/python/python-3.7.tgz failed.

    this is a major.minor.revision issue
    started over from scratch for better notes
    recap the method
        spack mirror remove main
        # manually deleted the mirror
        # go to the env location
        # spack mirror add --scope site tmp ./mirror-tmp
        # above appears to do nothing
        # spack mirror rm --scope site tmp
        # this appears to be sufficient, but check ~/.spack to be sure
        spack mirror create python@3.7.6
            ==> Adding package python@3.7.6 to mirror
            ==> Successfully updated mirror in file:///exec/rbradley/buildsite/factory/local/spack/var/spack/cache
        # clean up ~/.spack/cache but there should be no config in user site
        # attempt install inside singularity after setting cache
        # got really weird errors saying it was using icc for some reason
        rm -rf /exec/rbradley/buildsite/factory/local/spack/var/spack/cache/python/
        # ml gcc before making the cache after removing it above
        ml purge
        spack mirror create python@3.7.6
        spack clean
        # in the env in singularity now
        spack install -j 6


# Install programs with spack.
# To use: `make use specs/cli_spack.yaml`
# To run: `make spack_tree specs/spack_tree.yaml gromacs_gcc6`

# spack clone parent (for this file)
spot: ./local
# spack environments (for this file)
spot_envs: ./local/envs_spack

# template for spack.yaml used below
template_basic: 
  concretization: separately
  mirrors: {}
  repos: []
  upstreams: {}
  modules:
    enable: []
  definitions: []
  packages: {}
  config: 
    checksum: false
  specs: []
  view: false

bc-config: &bc-config-build
  # config for building
  config: &bc-config
    install_tree: /software/apps/spack/a02
    module_roots: 
      lmod: &module-spot /software/apps/spack/m02
    build_stage:
      - "$TMPDIR/$USER/spack-stage"
    misc_cache: /software/apps/spack/a02/cache_misc
  packages: &packages
    slurm:
      paths:
        slurm@17.11.12: /software/apps/slurm/17.11.12.1.marcc
      buildable: false
      version: []
      providers: {}
      modules: {}
      compiler: []
    openssl:
      paths: {openssl@1.0.2k: /usr}
      buildable: false

# standard whitelist follows for modulefiles
#whitelist-std: &whitelist-std ['gcc', 'openmpi /cr5qwwt']
whitelist-std: &whitelist-std ['gcc', 'openmpi', 'python']

bc-config-modules: &bc-config-std
  # config with modules
  config: *bc-config
  packages: *packages
  modules:
    enable: 
      - lmod
    lmod:
      all:
        conflict: []
        environment:
          unset: []
        filter:
          environment_blacklist: []
        load: []
        #! hdf5 and netcdf are pending
        suffixes:
          hdf5+cxx: serial
          netcdf+parallel-netcdf: parallel
      blacklist:
      - '%gcc@4.8.5'
      blacklist_implicits: true
      core_compilers:
      - gcc@4.8.5
      hash_length: 0
      naming_scheme: '{name}/{version}/{compiler.name}/{compiler.version}'
      hierarchy:
      - compiler
      - mpi
      verbose: false
      whitelist: *whitelist-std
      openmpi@3.4.1:
        environment:
          set:
            OMPI_MCA_mpi_warn_on_fork: '0'
          unset: []
        filter:
          environment_blacklist: []
        load: []
        conflict: []

openmpi-3_1_4: &openmpi-3_1_4 >-
    openmpi@3.1.4%gcc@7.4.0 +cuda +cxx_exceptions fabrics=verbs 
    +legacylaunchers+pmi schedulers=slurm ^slurm@17.11.12 ^cuda@9.2.88
    arch=linux-centos7-haswell

### ENVIRONMENTS

bc-prelim:
  notes: |
    Initial test before running a compiler build.
    #! needs retested
  envs:
    - check_compiler: gcc@4.8.5
    - bootstrap: null
    - name: test_init_v01
      via: template_basic
      #! needs retested after updates below
      mods: *bc-config-build
      specs:
        - zlib%gcc@4.8.5 arch=linux-centos7-haswell
        - cmake%gcc@4.8.5 arch=linux-centos7-haswell

bc-gcc-7:
  notes: Compile gcc 7 for Blue Crab.
  envs:
    - find_compilers: null
    - check_compiler: gcc@4.8.5
    - bootstrap: null
    - name: &env_gcc_7 env_gcc_7
      via: template_basic
      # build gcc without lmod refresh
      # lmod refresh occurs after we build packages below
      mods: *bc-config-build
      specs:
        - gcc@7.4.0 %gcc@4.8.5 arch=linux-centos7-haswell
    - find: gcc@7.4.0 
      name: *env_gcc_7

bc-gcc-7-base:
  notes: Blue Crab base apps built on gcc7.
  envs:
    - check_compiler: gcc@7.4.0
    - name: &env_gcc_7_base env_gcc_7_base
      via: template_basic
      mods: *bc-config-build
      specs:
        # include gcc for lmod
        - gcc@7.4.0 %gcc@4.8.5 arch=linux-centos7-haswell
        - gsl %gcc@7.4.0 arch=linux-centos7-haswell
        - cuda@9.2.88 %gcc@7.4.0 arch=linux-centos7-haswell
        - cuda@10.2.89 %gcc@7.4.0 arch=linux-centos7-haswell
        - python@3.7.6 %gcc@7.4.0 +optimizations +uuid arch=linux-centos7-haswell
        - py-pip@19.3 %gcc@7.4.0 arch=linux-centos7-haswell

bc-gcc-7-openmpi-3:
  notes: Blue Crab openmpi 3 built on gcc 7.
  envs:
    - check_compiler: gcc@7.4.0
    - name: &env_gcc_7_openmpi_3 env_gcc_7_openmpi_3
      via: template_basic
      mods: *bc-config-build
      specs:
        - *openmpi-3_1_4 

bc-std:
  notes: |
    Standard module tree on the new "stack" including gcc/openmpi.
    This is the first point at which we can deploy lmod.
  envs:
    - check_compiler: gcc@7.4.0
    - name: &env_std env_std
      via: template_basic
      mods: *bc-config-std
      specs:
        # include gcc for lmod
        # note that these specs must be added to whitelist-std
        - gcc@7.4.0 %gcc@4.8.5 arch=linux-centos7-haswell
        - gsl %gcc@7.4.0 arch=linux-centos7-haswell
        - cuda@9.2.88 %gcc@7.4.0 arch=linux-centos7-haswell
        - cuda@10.2.89 %gcc@7.4.0 arch=linux-centos7-haswell
        #! perform a pythonic list cat with the base
        - python@3.7.6 %gcc@7.4.0 +optimizations +uuid arch=linux-centos7-haswell
        - py-pip@19.3 %gcc@7.4.0 arch=linux-centos7-haswell
        - *openmpi-3_1_4 
    # specs must match mods modules for lmod refresh
    - lmod_refresh: null
      name: *env_std
    - lmod_hide_nested: *module-spot
