
# Install programs with spack.
# To use: `make use specs/cli_spack.yaml`
# To run: `make spack_tree specs/spack_tree.yaml gromacs_gcc6`

spot: ./local/spack
spot_envs: ./local/envs-spack

# template for spack.yaml used below
template_basic: 
  concretization: separately
  mirrors: {}
  repos: []
  upstreams: {}
  modules:
    enable: []
  definitions: []
  packages: {}
  config: 
    checksum: false
    # avoid the default cache in the home directory
    misc_cache: $spack/misc_cache
  specs: []
  view: false

gromacs_gcc6:
  notes: |
    This sequence installs gcc 6 which is necessary for compiling for skylake.
    Then it compiles gromacs with gcc 6 and little else.
    This recipe is designd for a standard CentOS7 box.
    We pin explicitly to the system gcc (4.8.5) to prevent recompile.
    We also use bootstrap to build modules.
    Last tested on alphaville on 2020.09.06.
  envs:
    - find_compilers: null
    #! dev auto-detect the system GCC if above 6
    - check_compiler: gcc@4.8.5
    - name: env_gcc_6.4.0
      via: template_basic
      specs: ['gcc@6.4.0%gcc@4.8.5']
    - find: gcc@6.4.0
    - name: env_gromacs
      via: template_basic
      specs: ['gromacs@2019.3%gcc@6.4.0']

gromacs_centos8_gpu:
  notes: |
    Install GROMACS with native GCC 8 on CentOS8 and CUDA.
    Last tested on heartland on 2020.09.05.
  envs:
    - find_compilers: null
    #! dev: check the major gcc version i.e. detect the native and use MAJ.MIN
    - check_compiler: gcc@8.3.1
    #! dev: create a naming scheme
    - name: env_gromacs_2020.3_gcc_8.3.1_native
      via: template_basic
      specs: ['gromacs@2020.3%gcc@8.3.1+cuda+mpi^cuda@10.2.89']
      cache_mirror: testbed

### TESTING

template_deploy: 
  concretization: separately
  mirrors: {}
  repos: []
  upstreams: {}
  modules:
    enable: [lmod]
    lmod:
      hash_length: 0
  definitions: []
  packages: {}
  config: 
    checksum: false
    # avoid the default cache in the home directory
    misc_cache: $spack/misc_cache
    # deploy location
    install_tree: /home/rpb/local/stack3app
    module_roots: 
      lmod: /home/rpb/local/stack3mod
  specs: []
  view: false

gromacs_deploy_test:
  notes: |
    Test the use of a build cache for installing somewhere else.
  envs:
    - find_compilers: null
    - check_compiler: gcc@8.3.1
    - name: env_gromacs_2020.3_gcc_8.3.1_native_deploy
      via: template_deploy
      specs: ['gromacs@2020.3%gcc@8.3.1+cuda+mpi^cuda@10.2.89']
      cache_only: true